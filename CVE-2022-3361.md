# CVE-2022-3361
The sink function is load_template() in class-shortcodes.php
This vulnerability looks like https://www.pritect.net/blog/ultimate-member-1-3-84-wordpress-shortcodes

![image](https://user-images.githubusercontent.com/48757788/198314636-da481f2a-bec1-43d4-a3d5-cc3d79ca3920.png)

If the result of file_exists($theme_file) is true, this function will include the theme_file

$theme_file has two parts: get_stylesheet_directory() and /ultimate-member/templates/{$tpl}.php

$tpl has not been filtered and if attacker can control the content of $tpl, he can include any php file he want and execute any code he want.

load_template() function is called by template_load() function in class-shortcodes.php

![image](https://user-images.githubusercontent.com/48757788/198314750-cb2fc24b-4d4d-41a2-8490-ad512c3faac6.png)

template_load() function is called by ultimatemember_account() function in class-account.php and ultimatemember_password() function in class-password.php at least

![image](https://user-images.githubusercontent.com/48757788/198314835-114b297e-0996-48cb-855d-b0d0789562ce.png)

![image](https://user-images.githubusercontent.com/48757788/198314895-15815072-feac-49f0-aa0a-6199f2cb509c.png)

Although $template has default value "account" or "password-reset", attacker can pass $args into function to cover it by wp_parse_args($args,$defaults);

Because $args['template'] is not filtered in any part, If attacker pass malicious $args into function, unexpected php file will be included

ultimatemember_account() function in class-account.php and ultimatemember_password() function in class-password.php can be called by shortcodes [ultimatemember_account] [ultimatemember_password]

Thus, if attacker (need permission to edit shortcodes) put [ultimatemember_account template=../../../../plugins/ultimate-member/includes/admin/templates/dashboard/users], users.php should be included. If a method could be discovered that allows uploading arbitrary PHP code, this could be used to execute that code.

However, this vulnerability has some limits. I tried this payload on my vps, $theme_file on my vps is /usr/local/lighthouse/softwares/wordpress/wp-content/themes/twentytwenty/ultimate-member/templates/

Because this path not exists, file_exists() will return false on Linux if the content has any wrong path.

However, Windows can handle the payload correctly.

The reason is that the method to handle the wrong path and ../ between Linux and Windows is different. https://stackoverflow.com/questions/62327748/relative-path-resolution-differences-between-windows-linux

Thus, if $theme_file is a real path on the host (Website manager has already cereated folder for adding new ultimate-member templates https://docs.ultimatemember.com/article/120-adding-your-custom-profile-templates, https://docs.ultimatemember.com/article/119-overriding-default-ultimate-member-profile-templates), this vulnerability can work on both Linux and Windows. On the contraty, this vulnerability can not work on Linux.

This is a Directory Traversal and Local File Inclusion vulnerability.

I added echo $theme_file; in class-shortcodes.php to hook the value of $theme_file on my vps

![image](https://user-images.githubusercontent.com/48757788/198315076-991952c2-0664-4c10-9d26-21c1a6273c7d.png)

![image](https://user-images.githubusercontent.com/48757788/198315132-ab348d14-a372-4afd-aae5-a321ace262c2.png)

![image](https://user-images.githubusercontent.com/48757788/198315164-357435ff-3d19-4fdc-8fc6-62a7c1e48a9a.png)

The result is the expected value.

After I create the folder and the path exists now, users.php is included.

![image](https://user-images.githubusercontent.com/48757788/198315291-5f508e6e-145a-45d3-a3b1-454f876c9c52.png)
















