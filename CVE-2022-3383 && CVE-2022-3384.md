# CVE-2022-3383 && CVE-2022-3384
Ultimate Member â€“ User Profile, User Registration, Login & Membership Plugin <= 2.5.0 - Authenticated (Admin+) Remote Code Execution via Multi-Select

The sink function is call_user_func() in several PHP files.

I found several vulnerabilities, some allows attracker to execute any command he want remotely, however some only allow attacker to execute specific PHP functions, just like phpinfo(). The detail will be showed below.

### CVE-2022-3383
RCE vulnerabilities are caused when two parameters of call_user_func() are all controlled by attacker in class-fields.php and class-form.php

These callback functions are used to help users defined their own functions. However, the parameters are not filtered.

There are several sink functions :
* get_option_value_from_callback(), get_options_from_callback(), edit_field() in class-fields.php
* ajax_select_options() in class-form.php

Take get_option_value_from_callback() as an example: 

![image](https://user-images.githubusercontent.com/48757788/198312855-b09af457-3fb6-4db5-9f63-1b57b0d6975a.png)

$data['custom_dropdown_options_source'] and $data['parent_dropdown_relationship'] are not filtered in this function.

This function is called by um_option_match_callback_view_field() in um-filters-fields.php

This function does not filter $data['custom_dropdown_options_source'] too

![image](https://user-images.githubusercontent.com/48757788/198313033-1d37b28b-0fb1-4efd-b457-7ba4916c408c.png)

This function is called when processing select/multiselect field

Fileds can be added here

![image](https://user-images.githubusercontent.com/48757788/198313106-a2e0bafe-63fc-48f0-9677-e6bc4c1bfb83.png)

The core part is Choices Callback, which corresponds to $data['custom_dropdown_options_source']

Then I capture the packet and add parameter _parent_dropdown_relationship=ls

![image](https://user-images.githubusercontent.com/48757788/198313270-748ed3c5-99d7-4643-b920-7bdca5876e7f.png)

Then I reload this page

![image](https://user-images.githubusercontent.com/48757788/198313361-36678927-f52d-4865-acd0-0f6349ff8c30.png)

And the result can be found in every users' profile

![image](https://user-images.githubusercontent.com/48757788/198313468-6ded172e-97fe-4c03-894e-f449898b4026.png)

Other functions may be called in some other methods. I have not tested them. Thus, I just show how to use get_option_value_from_callback() to RCE here.

### CVE-2022-3384
Some call_user_func() in ultimate member only has one parameter, just like populate_dropdown_options() in class-admin-builder.php

![image](https://user-images.githubusercontent.com/48757788/198313641-8b8648c1-7eb6-465d-a153-9ce538e71fcb.png)

This function can only execute non-parameter PHP function, just like phpinfo()

![image](https://user-images.githubusercontent.com/48757788/198313771-128f4404-8a3a-47e7-81ca-d60b9838184a.png)

And if attecker not add _parent_dropdown_relationship parameter in get_option_value_from_callback() he can only execute non-parameter PHP functions

I think some filters can be added to filter parameter to avoid the execution of unexpected functions






















